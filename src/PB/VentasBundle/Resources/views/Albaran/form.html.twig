   {% if form_errors(form) %}
          <div class="response-msg notice iu-corner-all">{{ form_errors(form) }}</div>
          {% endif %}

<form action="{{ entity.id  ? path('albaran_update', { 'id': entity.id }) : path('albaran_create') }}" method="post" {{ form_enctype(form) }}>
	<div class="portlet ui-widget ui-widget-content ui-helper-clearfix ui-corner-all form-container container-sin-header">
			<div class="form-invoice">
				<div class="span-17 form-horizontal label-column-small form-condensed">
					<div class="control-group required">
						{{ form_label(form.cliente, null, { 'label': 'Cliente', 'label_attr': {'class': 'control-label'} }) }}
						<div class="controls">
			    			{{ form_widget(form.cliente, { 'attr': {'class': 'small numeric buscadorid'}}) }}<a rel="prettyPhoto[iframe]" href="{{ path('buscador_cliente', { 'id': entity.id , 'iframe': 'true', 'width': 650, 'height': 400 }) }}" title="Buscador de Clientes"><img src="{{ asset('images/search.png') }}" /></a>
			    			
		        		</div>
	     			</div>
					<div class="control-group-pedido">
	     			      <label class="control-label">&nbsp;</label> 
	     			      <div class="controls nombre-cliente" style="display:none;"><h2>Nombre de cliente</h2></div>
	     			</div><div class="clearfix"></div>
	     			<div class="control-group required">
						{{ form_label(form.tipo, null, { 'label': 'Tipo', 'label_attr': {'class': 'control-label'} }) }}
						<div class="controls">
			    			{{ form_widget(form.tipo, { 'attr': {'class': 'small'}}) }}
		        		</div>
	     			</div>
     			</div>
     			<div class="span-17 form-horizontal label-column-small form-condensed">
	     			<div class="control-group required">
						{{ form_label(form.id, null, { 'label': 'Código Albarán', 'label_attr': {'class': 'control-label'} }) }}
						<div class="controls">
			    			{{ form_widget(form.id, { 'attr': {'class': 'small'}}) }}
		        		</div>
	     			</div>
	     			<div class="control-group-pedido">
	     			      <label class="control-label">&nbsp;</label> 
	     			</div><div class="clearfix"></div>
	     			<div class="control-group required">
						{{ form_label(form.fecha, null, { 'label': 'Fecha', 'label_attr': {'class': 'control-label'} }) }}
						<div class="controls">
			    			{{ form_widget(form.fecha, { 'attr': {'class': 'date small'}}) }}
		        		</div>
	     			</div>
     			</div>
      			<div class="span-16 form-horizontal label-column-small form-condensed">
					<div class="control-group required">
						{{ form_label(form.iva, null, { 'label': 'IVA', 'label_attr': {'class': 'control-label'} }) }}
						<div class="controls">
			    			{{ form_widget(form.iva, { 'attr': {'class': 'small'}}) }}
		        		</div>
	     			</div>
     			</div>
 			</div>
 	</div>
	<div class="clearfix"></div><br />
	<div id="invoice-lines">
      <div class="clearfix"></div>
     {% macro prototype(linea) %}
			<tr class="item-row">	
					<td class="editable">
					    {{ form_widget(linea.referencia, { 'attr': {'class': 'ta_right'}}) }}
					    <div class="delete-wrap"><a title="Borrar Linea" class="delete" href="#" onclick="return false;">&nbsp;</a></div>
					</td>
					<td class="editable">
					    {{ form_widget(linea.descripcion, { 'attr': {'class': 'idescripcion'}}) }}
					</td>
					<td class="editable">
					    {{ form_widget(linea.ancho, { 'attr': {'class': 'ta_right iancho numeric'}}) }}
					</td>
					<td class="editable">
					    {{ form_widget(linea.largo, { 'attr': {'class': 'ta_right ilargo numeric'}}) }}
					</td>
					<td class="editable">
					    {{ form_widget(linea.galga, { 'attr': {'class': 'ta_right igalga numeric'}}) }}
					</td>
					<td class="editable">
					    {{ form_widget(linea.cantidad, { 'attr': {'class': 'ta_right icantidad numeric'}}) }}
					</td>
					<td class="editable">
					    {{ form_widget(linea.precio, { 'attr': {'class': 'ta_right iprecio numeric'}}) }}
					</td>
					<td class="total">
						<span class="ta_right totallinea">{{ linea.importe.vars.value }}</span><!-- price -->
					 {{ form_widget(linea.importe, { 'attr': {'class': 'ta_right itotal'}}) }}
					</td> 
				</tr>
	     {% endmacro %}
		<table cellspacing="0" style="" class="invoice-lines spreadsheet" id="invoice-time">
			<thead>
				<tr>
					<th style="width: 60px;">Referencia</th>
					<th style="width: 310px;">Descripcion</th>
					<th style="width: 30px;">Ancho</th>
					<th style="width: 30px;">Largo</th>
					<th style="width: 30px;">Galga</th>
					<th class="ta_right" style="width: 45px;">Cantidad</th>
					<th class="ta_right" style="width: 45px;">Precio</th>
					<th class="ta_right last" style="width: 60px;">Total</th>
				</tr>
			</thead>

			<tbody>
			  {% for linea in form.albaranlineas %}
                {{_self.prototype(linea)}}
  			   {% endfor %}
			</tbody>
		</table>
	</div>
	<div class="prototipo" data-prototype="{{ _self.prototype(form.albaranlineas.get('prototype'))|e }}"></div>
	<div class="totals">
		<div class="rule top"></div>
	    	<div class="float_left">
	    		<div class="spreadsheet actions">
	    			<ul>
	    				<li title="" class="ui-state-default ui-corner-all"><span class="ui-icon ui-icon-plusthick"></span><a id="addrow" onclick="return false;" href="#">Añadir Línea</a></li>
	    			<ul>
	    		</div>
	    	</div>	
			<div class="box">
				<table cellspacing="0" class="table-totals">
					<tbody>
						<tr id="subtotal-row">
							<td style="width: 20px">&nbsp;{# form_widget(form.importetotal, { 'attr': {'class': 'iimporte'}}) #}</td>
							<th style="width: 150px">Total</th>
							<td class="last-column neto">0.00&euro;</td>
						</tr>
						<tr id="amount-row">
							<td style="width: 20px" class="last">&nbsp;{{ form_widget(form.iva, { 'attr': {'class': 'iiva'}}) }}</td>
							<th class="span-9 amount-cell"><span class="amount-total">Iva</span> <span class="currency">(21%)</span></th>
							<td class="last-column iva">0.00&euro;</td>
						</tr>
						<tr class="invoice-total-box" id="outstanding-row">
							<td style="width: 20px">&nbsp;&nbsp;{{ form_widget(form.importetotal, { 'attr': {'class': 'itotal2'}}) }}</td>
							<th>Total</th>
							<td class="last-column total2">0.00&euro;</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="clearfix"></div>
			<div class="observaciones">			
				{{ form_label(form.observaciones) }} <div class="clearfix"></div>
		    	{{ form_widget(form.observaciones, { 'attr': {'cols': '50', 'rows': '6'}}) }}
			</div>
	</div>
    <div class="clearfix"></div>
    <p>
        <button type="submit" class="ui-state-default ui-corner-all">Guardar</button>
    </p>
{{ form_widget(form._token) }}</form>
<script>
    var add = function() {
        var index = $('table.invoice-lines tbody tr').length;
        var prototype = $('.prototipo').attr('data-prototype');
        var row = prototype.replace(/__name__/g, index);
        $('table.invoice-lines tbody').append(row);
        bind();
    };

    $('#addrow').live('click', function(event) {
            add();
          //  event.preventDefault();
    });
    $(".delete").live('click',function(){
        $(this).closest('tr').remove();
        update_total();
        if ($(".delete").length < 2) $(".delete").hide();
        //event.preventDefault();
      });

    if ($('table.invoice-lines tbody tr').length === 0) {
        add();
    }
    $(document).ready(function() {
  	  //update_total();
  	  bindAlbaran();
  	});

</script>